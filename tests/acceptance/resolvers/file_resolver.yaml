suite: file_resolver
description: File resolver behavior for loading external files

tests:
  - name: reads_text_file
    given:
      files:
        data.txt: "Hello, World!"
      config: |
        content: ${file:data.txt}
    when:
      access: content
    then:
      value: "Hello, World!"

  - name: reads_yaml_file
    given:
      files:
        settings.yaml: |
          timeout: 30
          retries: 3
      config: |
        settings: ${file:settings.yaml}
    when:
      access: settings
    then:
      # The file resolver returns a mapping
      value:
        timeout: 30
        retries: 3

  - name: reads_json_file
    given:
      files:
        config.json: '{"host": "localhost", "port": 8080}'
      config: |
        server: ${file:config.json}
    when:
      access: server
    then:
      # The file resolver returns a mapping
      value:
        host: localhost
        port: 8080

  - name: file_not_found
    given:
      config: |
        content: ${file:nonexistent.txt}
    when:
      access: content
    then:
      error:
        type: ResolverError
        message_contains: "not found"

  - name: explicit_parse_mode_text
    given:
      files:
        data.yaml: "key: value"
      config: |
        content: ${file:data.yaml,parse=text}
    when:
      access: content
    then:
      value: "key: value"

  - name: encoding_utf8_default
    given:
      files:
        unicode.txt: "Hello, 世界!"
      config: |
        content: ${file:unicode.txt}
    when:
      access: content
    then:
      # Default encoding is UTF-8
      value_contains: "世界"

  - name: encoding_utf8_explicit
    given:
      files:
        unicode.txt: "café résumé"
      config: |
        content: ${file:unicode.txt,encoding=utf-8}
    when:
      access: content
    then:
      value_contains: "café"

  - name: encoding_ascii_strips_non_ascii
    given:
      files:
        unicode.txt: "Hello, 世界!"
      config: |
        content: ${file:unicode.txt,encoding=ascii}
    when:
      access: content
    then:
      # ASCII mode should strip non-ASCII characters
      value: "Hello, !"

  # Path Security Tests
  # Note: These tests will fail until path validation is implemented

  - name: allows_file_in_subdirectory
    given:
      files:
        subdir/data.txt: "allowed"
      config: |
        value: ${file:subdir/data.txt}
    when:
      access: value
    then:
      value: "allowed"

  - name: blocks_absolute_path_outside_roots
    given:
      config: |
        value: ${file:/etc/passwd}
    when:
      access: value
    then:
      error:
        type: ResolverError
        message_contains: "escapes allowed roots"
