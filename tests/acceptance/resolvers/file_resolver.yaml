suite: file_resolver
description: File resolver behavior for loading external files

tests:
  - name: reads_text_file
    given:
      files:
        data.txt: "Hello, World!"
      config: |
        content: ${file:data.txt}
    when:
      access: content
    then:
      value: "Hello, World!"

  - name: reads_yaml_file
    given:
      files:
        settings.yaml: |
          timeout: 30
          retries: 3
      config: |
        settings: ${yaml:${file:settings.yaml}}
    when:
      access: settings
    then:
      # File resolver returns text, yaml resolver parses it
      value:
        timeout: 30
        retries: 3

  - name: reads_json_file
    given:
      files:
        config.json: '{"host": "localhost", "port": 8080}'
      config: |
        server: ${json:${file:config.json}}
    when:
      access: server
    then:
      # File resolver returns text, json resolver parses it
      value:
        host: localhost
        port: 8080

  - name: file_not_found
    given:
      config: |
        content: ${file:nonexistent.txt}
    when:
      access: content
    then:
      error:
        type: ResolverError
        message_contains: "not found"

  - name: explicit_parse_mode_text
    given:
      files:
        data.yaml: "key: value"
      config: |
        content: ${file:data.yaml,parse=text}
    when:
      access: content
    then:
      value: "key: value"

  - name: encoding_utf8_default
    given:
      files:
        unicode.txt: "Hello, 世界!"
      config: |
        content: ${file:unicode.txt}
    when:
      access: content
    then:
      # Default encoding is UTF-8
      value_contains: "世界"

  - name: encoding_utf8_explicit
    given:
      files:
        unicode.txt: "café résumé"
      config: |
        content: ${file:unicode.txt,encoding=utf-8}
    when:
      access: content
    then:
      value_contains: "café"

  - name: encoding_ascii_strips_non_ascii
    given:
      files:
        unicode.txt: "Hello, 世界!"
      config: |
        content: ${file:unicode.txt,encoding=ascii}
    when:
      access: content
    then:
      # ASCII mode should strip non-ASCII characters
      value: "Hello, !"

  # Path Security Tests
  # Note: These tests will fail until path validation is implemented

  - name: allows_file_in_subdirectory
    given:
      files:
        subdir/data.txt: "allowed"
      config: |
        value: ${file:subdir/data.txt}
    when:
      access: value
    then:
      value: "allowed"

  - name: blocks_absolute_path_outside_roots
    given:
      config: |
        value: ${file:/etc/passwd}
    when:
      access: value
    then:
      error:
        type: ResolverError
        message_contains: "allowed"

  # RFC 8089 file: URI Compliance Tests
  # Note: Absolute path tests (file:///, file://localhost, file:/) require
  # test framework support for file_roots configuration. For now, we test
  # the parsing and error handling logic.

  - name: rfc8089_reject_remote_hostname
    given:
      config: |
        value: ${file://server.example.com/share/config.yaml}
    when:
      access: value
    then:
      error:
        type: ResolverError
        message_contains: "Remote file URIs not supported"

  - name: rfc8089_relative_path_unchanged
    given:
      files:
        data.txt: "relative path test"
      config: |
        value: ${file:data.txt}
    when:
      access: value
    then:
      value: "relative path test"
